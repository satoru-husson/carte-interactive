<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte Interactive avec GeoJSON</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        body { display: flex; }
        #sidebar { width: 18%; padding: 20px; }
        #map { height: 800px; width: 82%; margin-bottom: 20px; }
        .capability { margin-bottom: 15px; }
        .sub-cap-btn { margin: 5px; }
        .active { background: #3388ff; color: #fff; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Capabilities</h2>
        <div id="capabilities-container"></div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    // Initialisation de la carte centrée sur le monde
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Chargement du GeoJSON des pays
    fetch('countries.geojson')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                style: {
                    color: "#3388ff",
                    weight: 1,
                    fillOpacity: 0.2
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(feature.properties.ADMIN || "Pays");
                }
            }).addTo(map);
        })
        .catch(err => { alert("Impossible de charger countries.geojson"); });

    // Exemple de structure de capabilities et sous-capabilities
    const capabilitiesData = [
        {
            name: "Capability 1",
            subCapabilities: [
                { name: "Subcap 1", products: ["Produit A", "Produit B"] },
                { name: "Subcap 2", products: ["Produit C"] },
                { name: "Subcap 3", products: [] },
                { name: "Subcap 4", products: [] },
                { name: "Subcap 5", products: [] }
            ]
        },
        {
            name: "Capability 2",
            subCapabilities: [
                { name: "Subcap 1", products: [] },
                { name: "Subcap 2", products: [] },
                { name: "Subcap 3", products: [] },
                { name: "Subcap 4", products: [] },
                { name: "Subcap 5", products: [] }
            ]
        },
        {
            name: "Capability 3",
            subCapabilities: [
                { name: "Subcap 1", products: [] },
                { name: "Subcap 2", products: [] },
                { name: "Subcap 3", products: [] },
                { name: "Subcap 4", products: [] },
                { name: "Subcap 5", products: [] }
            ]
        },
        {
            name: "Capability 4",
            subCapabilities: [
                { name: "Subcap 1", products: [] },
                { name: "Subcap 2", products: [] },
                { name: "Subcap 3", products: [] },
                { name: "Subcap 4", products: [] },
                { name: "Subcap 5", products: [] }
            ]
        },
        {
            name: "Capability 5",
            subCapabilities: [
                { name: "Subcap 1", products: [] },
                { name: "Subcap 2", products: [] },
                { name: "Subcap 3", products: [] },
                { name: "Subcap 4", products: [] },
                { name: "Subcap 5", products: [] }
            ]
        },
        {
            name: "Capability 6",
            subCapabilities: [
                { name: "Subcap 1", products: [] },
                { name: "Subcap 2", products: [] },
                { name: "Subcap 3", products: [] },
                { name: "Subcap 4", products: [] },
                { name: "Subcap 5", products: [] }
            ]
        }
    ];

    let selectedCapability = null;
    let productsData = {};

    function renderCapabilities() {
        const container = document.getElementById('capabilities-container');
        container.innerHTML = '';
        capabilitiesData.forEach((cap, i) => {
            const capBtn = document.createElement('button');
            capBtn.textContent = cap.name;
            capBtn.className = 'cap-btn' + (selectedCapability === i ? ' active' : '');
            capBtn.onclick = () => {
                selectedCapability = (selectedCapability === i) ? null : i;
                renderCapabilities();
            };
            container.appendChild(capBtn);

            if (selectedCapability === i) {
                cap.subCapabilities.forEach((sub, j) => {
                    const subBtn = document.createElement('button');
                    subBtn.textContent = sub.name;
                    subBtn.className = 'sub-cap-btn';
                    subBtn.onclick = () => {
                        showCountriesForSubcapability(cap.name, sub.name);
                    };
                    container.appendChild(subBtn);
                });
            }
        });
    }

    function showCountriesForSubcapability(capName, subName) {
        // Efface la carte précédente
        map.eachLayer(function (layer) {
            if (layer instanceof L.GeoJSON) {
                map.removeLayer(layer);
            }
        });
        fetch('countries.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: {
                        color: "#3388ff",
                        weight: 1,
                        fillOpacity: 0.2
                    },
                    filter: function(feature) {
                        const country = feature.properties.ADMIN;
                        return productsData.productsBySubcapability[capName] &&
                            productsData.productsBySubcapability[capName][subName] &&
                            productsData.productsBySubcapability[capName][subName][country] &&
                            productsData.productsBySubcapability[capName][subName][country].length > 0;
                    },
                    onEachFeature: function (feature, layer) {
                        const country = feature.properties.ADMIN;
                        const products = productsData.productsBySubcapability[capName][subName][country] || [];
                        let popupHtml = `<strong>${country}</strong><br/>Produits:<ul>`;
                        products.forEach(prod => {
                            popupHtml += `<li>${prod}</li>`;
                        });
                        popupHtml += '</ul>';
                        layer.bindPopup(popupHtml);
                    }
                }).addTo(map);
            });
    }

    window.addEventListener('DOMContentLoaded', () => {
        fetch('data.json')
            .then(r => r.json())
            .then(data => {
                productsData = data;
                renderCapabilities();
            });
    });
    </script>
</body>
</html>




