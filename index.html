<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte Interactive</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { height: 100vh; width: 100vw; }
    #map-container { position: relative; height: 100vh; width: 100vw; }
    #map { height: 100vh; width: 100vw; }
    #sidebar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100vh;
        width: 320px;
        min-width: 220px;
        max-width: 400px;
        padding: 20px 10px 20px 20px;
        background: rgba(250,250,250,0.97);
        overflow-y: auto;
        z-index: 1100;
        box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }
    #sidebar h3 {
        margin-top: 0;
        margin-bottom: 16px;
        font-size: 1.2em;
        font-weight: bold;
        color: #1a237e;
    }
    ul.arbo {
        list-style-type: none;
        padding-left: 0;
        margin: 0;
    }
    .l1-li {
        margin-bottom: 10px;
    }
    .l1-div {
        cursor: pointer;
        font-weight: bold;
        color: #1a237e;
        padding: 8px 0;
        transition: background 0.2s;
        border-radius: 4px;
    }
    .l1-div:hover {
        background: #e3e6f5;
    }
    ul.l2-list {
        list-style-type: circle;
        margin-left: 24px;
        margin-top: 6px;
        margin-bottom: 6px;
        padding-left: 0;
    }
    .l2-li {
        cursor: pointer;
        padding: 6px 0;
        color: #0d133d;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .l2-li:hover {
        background: #e3e6f5;
    }
    .country-count-icon {
        pointer-events: none;
    }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div id="sidebar">
            <h3>Arborescence L1</h3>
            <ul id="l1-tree" class="arbo"></ul>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
        import { showCountryCounts } from './countryCounts.js';
        import { countries } from './countriesList.js';

        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Stockage des layers de pays
        const countryLayers = {};

        // Variables pour stocker la L1/L2 sélectionnée
        let selectedL1 = null;
        let selectedL2 = null;

        // Arborescence dynamique depuis data.json
        let l1TreeData = {};
        let expanded = {};

        // Regroupe les données par L1 puis L2
        function buildTree(data) {
            const tree = {};
            data.forEach(item => {
                if (!tree[item.l1]) tree[item.l1] = {};
                if (!tree[item.l1][item.l2]) tree[item.l1][item.l2] = [];
                tree[item.l1][item.l2].push(item);
            });
            return tree;
        }

        function renderL1Tree() {
            const treeElem = document.getElementById('l1-tree');
            treeElem.innerHTML = '';

            // Liste fixe des L1
            const l1Names = [
                "Order Management",
                "Transport Management",
                "Carrier Management",
                "Asset & Network Management",
                "From Offering to Pricing",
                "Finance Management"
            ];

            l1Names.forEach((l1, i) => {
                if (!l1TreeData[l1]) return; // Ignore si pas de données pour ce L1

                const li = document.createElement('li');
                li.className = 'l1-li';

                const l1Div = document.createElement('div');
                l1Div.className = 'l1-div';
                l1Div.textContent = (expanded[l1] ? '▼ ' : '► ') + (i + 1) + '. ' + l1;
                l1Div.onclick = () => {
                    expanded[l1] = !expanded[l1];
                    renderL1Tree();
                };
                li.appendChild(l1Div);

                if (expanded[l1]) {
                    const l2List = document.createElement('ul');
                    l2List.className = 'l2-list';

                    const l2Keys = Object.keys(l1TreeData[l1]);
                    l2Keys.forEach((l2, j) => {
                        const l2li = document.createElement('li');
                        l2li.className = 'l2-li';
                        l2li.textContent = (i + 1) + '.' + (j + 1) + ' ' + l2;
                        l2li.onclick = (e) => {
                            e.stopPropagation();
                            showCountriesPopup(l1, l2);
                        };
                        l2List.appendChild(l2li);
                    });

                    li.appendChild(l2List);
                }

                treeElem.appendChild(li);
            });
        }

        // Modifie la fonction showCountriesPopup pour mémoriser la sélection
        function showCountriesPopup(l1, l2) {
            selectedL1 = l1;
            selectedL2 = l2;
            showCountryCounts(map, l1TreeData, l1, l2);
        }

        window.addEventListener('DOMContentLoaded', () => {
            fetch('data.json')
                .then(r => r.json())
                .then(data => {
                    l1TreeData = buildTree(data);
                    Object.keys(l1TreeData).forEach(l1 => expanded[l1] = false);
                    renderL1Tree();

                    // Charge le GeoJSON des pays APRÈS avoir les données
                    fetch('countries.geojson')
                        .then(response => response.json())
                        .then(geoData => {
                            L.geoJSON(geoData, {
                                style: {
                                    color: "#3388ff",
                                    weight: 1,
                                    fillOpacity: 0.2
                                },
                                onEachFeature: function (feature, layer) {
                                    if (feature.properties && feature.properties.ADMIN) {
                                        countryLayers[feature.properties.ADMIN] = layer;
                                        layer.on('click', function () {
                                            if (!selectedL1 || !selectedL2) return;
                                            const items = l1TreeData[selectedL1][selectedL2] || [];
                                            const filtered = items.filter(item => item.countries && item.countries.includes(feature.properties.ADMIN));
                                            if (filtered.length === 0) {
                                                L.popup()
                                                    .setLatLng(layer.getBounds().getCenter())
                                                    .setContent(`<b>${feature.properties.ADMIN}</b><br>Aucun item`)
                                                    .openOn(map);
                                            } else {
                                                const content = filtered.map(item => item.name).join('<br>');
                                                L.popup()
                                                    .setLatLng(layer.getBounds().getCenter())
                                                    .setContent(`<b>${feature.properties.ADMIN}</b><br>${content}`)
                                                    .openOn(map);
                                            }
                                        });
                                    }
                                }
                            }).addTo(map);
                        });
                });
        });
    </script>
</body>
</html>




